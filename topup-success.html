<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top up • PremiumShop</title>
  <style>
    :root{--bg:#05060a;--bg2:#070a12;--text:#f4f6ff;--muted:rgba(244,246,255,.72);--shadow2:0 16px 55px rgba(0,0,0,.52);--r22:22px;--max:900px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:radial-gradient(1200px 700px at 50% -10%, rgba(233,237,247,.16), rgba(0,0,0,0) 62%),
      radial-gradient(900px 600px at 12% 80%, rgba(96,165,250,.12), rgba(0,0,0,0) 66%),
      radial-gradient(900px 600px at 88% 85%, rgba(255,255,255,.06), rgba(0,0,0,0) 68%),
      linear-gradient(180deg,var(--bg2),var(--bg));}
    a{color:inherit;text-decoration:none}
    .wrap{width:min(var(--max),92vw);margin:40px auto}
    .card{border-radius:var(--r22);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);box-shadow:var(--shadow2);padding:18px}
    h1{margin:0;font-size:clamp(26px,4vw,42px);text-transform:uppercase;letter-spacing:.6px}
    .sub{margin:10px 0 0;color:var(--muted);font-weight:850;line-height:1.55}
    .row{margin-top:14px;padding:12px;border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.30)}
    .label{opacity:.75;font-weight:950;font-size:12px;letter-spacing:.2px;text-transform:uppercase}
    .value{margin-top:6px;font-weight:1100;letter-spacing:.2px;word-break:break-all}
    .actions{margin-top:16px;display:flex;flex-wrap:wrap;gap:10px}
    .btn{padding:11px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);font-weight:1000;letter-spacing:.22px;box-shadow:0 16px 40px rgba(0,0,0,.42)}
    .btnPrimary{background:linear-gradient(135deg, rgba(233,237,247,.20), rgba(255,255,255,.06), rgba(96,165,250,.12));border-color:rgba(255,255,255,.18)}
    .pill{display:inline-flex;margin-top:12px;gap:8px;padding:9px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(10,12,18,.58);font-weight:1000;font-size:12.5px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 id="headline">Top up Status</h1>
      <p class="sub" id="msg">Bitte warten…</p>

      <div class="row">
        <div class="label">Topup ID</div>
        <div class="value" id="topupId">—</div>
      </div>

      <div class="row" id="amountRow" style="display:none;">
        <div class="label">Betrag</div>
        <div class="value" id="amount">—</div>
      </div>

      <div class="pill" id="badge" style="display:none;">⏳ Zahlung wird bestätigt…</div>

      <div class="actions">
        <a class="btn btnPrimary" href="balance.html">Zur Balance</a>
        <a class="btn" href="cart.html">Zum Cart</a>
      </div>
    </div>
  </div>

  <script>
    function formatEURFromCents(c){ return "€" + ((Number(c)||0)/100).toFixed(2); }

    const params = new URLSearchParams(location.search);
    const paid = params.get("paid");
    const topupId = params.get("topupId") || "";

    document.getElementById("topupId").textContent = topupId || "—";

    const headline = document.getElementById("headline");
    const msg = document.getElementById("msg");
    const badge = document.getElementById("badge");
    const amountRow = document.getElementById("amountRow");
    const amountEl = document.getElementById("amount");

    if(paid !== "1" || !topupId){
      headline.textContent = "Keine Zahlungsinfo";
      msg.textContent = "Hinweis: Kein gültiger Top-up gefunden.";
    } else {
      headline.textContent = "Top up gestartet ✅";
      msg.textContent = "Wir warten auf Bestätigung (Webhook).";
      badge.style.display = "inline-flex";

      async function poll(){
        try{
          const res = await fetch("/api/topup/status?topupId=" + encodeURIComponent(topupId), { credentials:"include" });
          const data = await res.json().catch(()=>null);

          if(res.status === 401){
            location.href = "login.html?next=" + encodeURIComponent("topup-success.html?paid=1&topupId=" + topupId);
            return;
          }

          if(data && data.status === "pending"){
            amountRow.style.display = "block";
            amountEl.textContent = formatEURFromCents(data.amountCents);
            msg.textContent = "Zahlung pending… bitte kurz warten.";
            setTimeout(poll, 1500);
            return;
          }

          // credited_or_unknown
          badge.style.display = "none";
          msg.textContent = "Top-up wurde bestätigt (oder bereits verbucht). Schau in Balance nach.";
        }catch(e){
          setTimeout(poll, 2000);
        }
      }

      poll();
    }
  </script>
</body>
</html>